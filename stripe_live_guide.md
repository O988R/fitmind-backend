# دليل الانتقال إلى Stripe الحقيقي (Live) لتطبيق FitMind

هذا الدليل يشرح خطوات الانتقال من بيئة Stripe التجريبية (Test) إلى البيئة الحقيقية (Live) لتطبيق FitMind، مع التركيز على متطلبات التفعيل التجاري في النمسا.

## جدول المحتويات

1. [مقدمة](#مقدمة)
2. [الفرق بين بيئة Stripe التجريبية والحقيقية](#الفرق-بين-بيئة-stripe-التجريبية-والحقيقية)
3. [متطلبات تفعيل حساب Stripe التجاري في النمسا](#متطلبات-تفعيل-حساب-stripe-التجاري-في-النمسا)
4. [خطوات الانتقال إلى Stripe الحقيقي](#خطوات-الانتقال-إلى-stripe-الحقيقي)
5. [تحديث متغيرات البيئة في التطبيق](#تحديث-متغيرات-البيئة-في-التطبيق)
6. [اختبار المدفوعات الحقيقية](#اختبار-المدفوعات-الحقيقية)
7. [إعداد Webhook في البيئة الحقيقية](#إعداد-webhook-في-البيئة-الحقيقية)
8. [الامتثال القانوني والضريبي](#الامتثال-القانوني-والضريبي)
9. [أفضل الممارسات الأمنية](#أفضل-الممارسات-الأمنية)
10. [استكشاف الأخطاء وإصلاحها](#استكشاف-الأخطاء-وإصلاحها)

## مقدمة

عند تطوير تطبيق FitMind، استخدمنا بيئة Stripe التجريبية (Test) لاختبار وظائف المدفوعات والاشتراكات والعمولات. الآن، بعد الانتهاء من التطوير والاختبار، حان الوقت للانتقال إلى بيئة Stripe الحقيقية (Live) لبدء قبول المدفوعات الفعلية من المستخدمين.

## الفرق بين بيئة Stripe التجريبية والحقيقية

قبل البدء، من المهم فهم الفروق الرئيسية بين البيئتين:

| الميزة | البيئة التجريبية (Test) | البيئة الحقيقية (Live) |
|--------|-------------------------|------------------------|
| المدفوعات | وهمية، لا يتم خصم أموال حقيقية | حقيقية، يتم خصم أموال فعلية من العملاء |
| المفاتيح | تبدأ بـ `pk_test_` و `sk_test_` | تبدأ بـ `pk_live_` و `sk_live_` |
| بطاقات الاختبار | يمكن استخدام بطاقات اختبار مثل `4242 4242 4242 4242` | تتطلب بطاقات حقيقية صالحة |
| لوحة التحكم | منفصلة عن البيئة الحقيقية | منفصلة عن البيئة التجريبية |
| التحقق من الهوية | غير مطلوب | مطلوب للامتثال التنظيمي |
| الرسوم | لا توجد رسوم | رسوم على كل معاملة (عادة 2.9% + $0.30) |

## متطلبات تفعيل حساب Stripe التجاري في النمسا

لتفعيل حساب Stripe تجاري في النمسا، ستحتاج إلى توفير المعلومات والوثائق التالية:

### للأفراد:

1. **معلومات شخصية**:
   - الاسم الكامل
   - تاريخ الميلاد
   - العنوان الشخصي
   - رقم الهاتف
   - عنوان البريد الإلكتروني

2. **وثائق الهوية**:
   - نسخة من جواز السفر أو بطاقة الهوية الوطنية
   - إثبات العنوان (فاتورة مرافق حديثة، كشف حساب بنكي، إلخ)

3. **معلومات البنك**:
   - تفاصيل الحساب البنكي (IBAN)
   - رمز SWIFT/BIC

4. **معلومات الضريبة**:
   - رقم التعريف الضريبي (Steuernummer)
   - رقم تسجيل ضريبة القيمة المضافة (UID-Nummer) إذا كان متاحاً

### للشركات:

1. **معلومات الشركة**:
   - اسم الشركة القانوني
   - رقم تسجيل الشركة (Firmenbuchnummer)
   - عنوان الشركة المسجل
   - نوع الشركة القانوني (GmbH، KG، إلخ)

2. **معلومات المالك/المدير**:
   - الاسم الكامل
   - تاريخ الميلاد
   - العنوان الشخصي
   - نسخة من جواز السفر أو بطاقة الهوية

3. **وثائق الشركة**:
   - شهادة تسجيل الشركة (Firmenbuchauszug)
   - عقد تأسيس الشركة (Gesellschaftsvertrag)
   - إثبات عنوان الشركة

4. **معلومات البنك**:
   - تفاصيل الحساب البنكي للشركة (IBAN)
   - رمز SWIFT/BIC

5. **معلومات الضريبة**:
   - رقم التعريف الضريبي للشركة (Steuernummer)
   - رقم تسجيل ضريبة القيمة المضافة (UID-Nummer)

### متطلبات إضافية:

1. **سياسة الخصوصية وشروط الخدمة**:
   - يجب أن يكون لديك سياسة خصوصية وشروط خدمة واضحة على موقعك
   - يجب أن تتوافق هذه السياسات مع قوانين الاتحاد الأوروبي (GDPR)

2. **وصف النشاط التجاري**:
   - شرح مفصل لنموذج العمل
   - نوع المنتجات أو الخدمات التي تقدمها
   - كيفية تحصيل المدفوعات وتسليم المنتجات/الخدمات

3. **موقع ويب أو تطبيق جاهز**:
   - يجب أن يكون لديك موقع ويب أو تطبيق جاهز للعمل
   - يجب أن يعرض الموقع معلومات الاتصال والسياسات بوضوح

## خطوات الانتقال إلى Stripe الحقيقي

### 1. إكمال تفعيل حساب Stripe

1. **تسجيل الدخول إلى لوحة تحكم Stripe**:
   - قم بزيارة [dashboard.stripe.com](https://dashboard.stripe.com)
   - سجل الدخول باستخدام بيانات اعتماد حسابك

2. **التبديل إلى وضع Live**:
   - في الزاوية اليسرى السفلية من لوحة التحكم، انقر على "Test Mode"
   - اختر "Live Mode" من القائمة المنسدلة

3. **إكمال عملية التحقق**:
   - انقر على "Complete verification" أو "Activate account"
   - اتبع الخطوات لتقديم جميع المعلومات والوثائق المطلوبة
   - قد تستغرق عملية التحقق من 1 إلى 5 أيام عمل

### 2. إعداد طرق الدفع

1. **تكوين طرق الدفع المقبولة**:
   - انتقل إلى "Settings" > "Payment methods"
   - قم بتفعيل طرق الدفع التي ترغب في قبولها (بطاقات الائتمان، Apple Pay، Google Pay، إلخ)

2. **تخصيص تجربة الدفع**:
   - انتقل إلى "Settings" > "Branding"
   - قم بتحميل شعار شركتك
   - خصص ألوان صفحة الدفع لتتناسب مع هوية علامتك التجارية

### 3. إعداد المنتجات والأسعار في البيئة الحقيقية

1. **إنشاء المنتجات**:
   - انتقل إلى "Products"
   - انقر على "Add product"
   - أدخل اسم المنتج ووصفه
   - أضف صورة للمنتج (اختياري)

2. **إنشاء الأسعار**:
   - في صفحة المنتج، انقر على "Add price"
   - حدد نوع السعر (مرة واحدة أو متكرر)
   - أدخل السعر والعملة
   - لأسعار الاشتراك، حدد الفترة (شهرياً، سنوياً، إلخ)

3. **إنشاء الكوبونات**:
   - انتقل إلى "Billing" > "Coupons"
   - انقر على "Create coupon"
   - حدد نوع الخصم (نسبة مئوية أو مبلغ ثابت)
   - حدد مدة الصلاحية وعدد الاستخدامات

### 4. إعداد الحسابات المتصلة للمدربين

1. **إنشاء حسابات متصلة**:
   - انتقل إلى "Connect" > "Accounts"
   - انقر على "Create"
   - اختر نوع الحساب المتصل (Express أو Standard أو Custom)
   - أدخل معلومات المدرب

2. **إعداد عملية التحقق للمدربين**:
   - قم بإنشاء رابط تسجيل لكل مدرب
   - أرسل الرابط إلى المدرب لإكمال عملية التحقق
   - تأكد من أن المدربين يقدمون جميع المعلومات والوثائق المطلوبة

## تحديث متغيرات البيئة في التطبيق

بعد تفعيل حساب Stripe الحقيقي، يجب تحديث متغيرات البيئة في التطبيق:

1. **الحصول على مفاتيح API الحقيقية**:
   - في لوحة تحكم Stripe، انتقل إلى "Developers" > "API keys"
   - انسخ "Publishable key" و "Secret key"

2. **تحديث ملف `.env`**:
   - قم بتحديث المتغيرات التالية:
     ```
     STRIPE_SECRET_KEY=sk_live_your_live_secret_key
     STRIPE_PUBLISHABLE_KEY=pk_live_your_live_publishable_key
     ```

3. **تحديث متغيرات البيئة في خدمات الاستضافة**:
   - قم بتحديث متغيرات البيئة في منصة الاستضافة (Render، Railway، DigitalOcean، إلخ)
   - تأكد من عدم نشر المفاتيح السرية في مستودع Git

## اختبار المدفوعات الحقيقية

قبل إطلاق التطبيق للجمهور، من المهم اختبار المدفوعات الحقيقية:

1. **إجراء اختبار داخلي**:
   - قم بإجراء عملية شراء حقيقية بمبلغ صغير (مثلاً $1)
   - تأكد من أن العملية تتم بنجاح من البداية إلى النهاية
   - تحقق من استلام الإشعارات والتأكيدات

2. **اختبار الاشتراكات**:
   - قم بإنشاء اشتراك تجريبي
   - تأكد من أن الفوترة تعمل بشكل صحيح
   - اختبر إلغاء الاشتراك وتأكد من عدم تجديده

3. **اختبار العمولات**:
   - قم بإجراء عملية شراء لمحتوى مدرب
   - تأكد من حساب العمولة بشكل صحيح
   - تحقق من تحويل العمولة إلى حساب المدرب

## إعداد Webhook في البيئة الحقيقية

Webhook هي طريقة لتلقي إشعارات من Stripe عن الأحداث التي تحدث في حسابك:

1. **إنشاء Webhook**:
   - في لوحة تحكم Stripe، انتقل إلى "Developers" > "Webhooks"
   - انقر على "Add endpoint"
   - أدخل عنوان URL للـ webhook (مثلاً `https://api.fitmind.com/stripe/webhook`)
   - حدد الأحداث التي ترغب في تلقي إشعارات عنها (مثل `payment_intent.succeeded`، `invoice.paid`، إلخ)

2. **الحصول على سر Webhook**:
   - بعد إنشاء Webhook، انقر على "Reveal" لعرض سر Webhook
   - انسخ السر وأضفه إلى متغيرات البيئة:
     ```
     STRIPE_WEBHOOK_SECRET=whsec_your_live_webhook_secret
     ```

3. **اختبار Webhook**:
   - قم بإجراء عملية دفع تجريبية
   - تحقق من سجلات التطبيق للتأكد من استلام الإشعار
   - تحقق من سجلات Webhook في لوحة تحكم Stripe

## الامتثال القانوني والضريبي

عند قبول المدفوعات الحقيقية، يجب الامتثال للمتطلبات القانونية والضريبية:

### 1. الامتثال لقوانين حماية البيانات

1. **GDPR (اللائحة العامة لحماية البيانات)**:
   - تأكد من أن سياسة الخصوصية تتوافق مع متطلبات GDPR
   - احصل على موافقة صريحة قبل جمع بيانات الدفع
   - قم بتنفيذ آليات لتمكين المستخدمين من ممارسة حقوقهم (الوصول، التصحيح، الحذف، إلخ)

2. **تخزين البيانات**:
   - لا تخزن بيانات بطاقات الائتمان على خوادمك
   - استخدم Stripe Elements أو Checkout لجمع بيانات الدفع بشكل آمن

### 2. الامتثال الضريبي

1. **ضريبة القيمة المضافة (VAT)**:
   - قم بتكوين الضرائب في Stripe:
     - انتقل إلى "Settings" > "Tax"
     - قم بتفعيل "Stripe Tax" أو قم بتكوين الضرائب يدوياً
   - تأكد من تحصيل ضريبة القيمة المضافة بالمعدل الصحيح حسب موقع العميل
   - قم بإصدار فواتير تتضمن معلومات ضريبة القيمة المضافة

2. **التقارير الضريبية**:
   - احتفظ بسجلات دقيقة لجميع المعاملات
   - قم بإعداد تقارير ضريبية دورية
   - استشر محاسباً للتأكد من الامتثال للمتطلبات الضريبية المحلية

### 3. شروط الخدمة وسياسات الاسترداد

1. **شروط الخدمة**:
   - تأكد من أن شروط الخدمة تتضمن معلومات واضحة عن:
     - كيفية عمل الاشتراكات والتجديد التلقائي
     - حقوق الإلغاء والاسترداد
     - المسؤوليات والضمانات

2. **سياسة الاسترداد**:
   - قم بوضع سياسة استرداد واضحة
   - حدد الشروط والمدة الزمنية للاسترداد
   - تأكد من أن السياسة متوافقة مع قوانين حماية المستهلك في الاتحاد الأوروبي

## أفضل الممارسات الأمنية

عند التعامل مع المدفوعات الحقيقية، يجب اتباع أفضل الممارسات الأمنية:

1. **حماية المفاتيح السرية**:
   - لا تقم أبداً بنشر المفاتيح السرية في مستودع Git
   - استخدم متغيرات البيئة لتخزين المفاتيح
   - قم بتدوير المفاتيح بشكل دوري

2. **التحقق من صحة Webhook**:
   - تحقق دائماً من توقيع Webhook للتأكد من أن الطلب قادم من Stripe
   - استخدم مكتبة Stripe الرسمية للتحقق من التوقيع

3. **مراقبة الاحتيال**:
   - قم بتفعيل Stripe Radar لاكتشاف ومنع عمليات الاحتيال
   - قم بإعداد قواعد مخصصة لتناسب نموذج عملك
   - راجع المعاملات المشبوهة بانتظام

4. **التشفير والأمان**:
   - استخدم HTTPS لجميع الاتصالات
   - قم بتنفيذ تشفير البيانات أثناء النقل والتخزين
   - قم بتحديث المكتبات والتبعيات بانتظام

5. **التسجيل والمراقبة**:
   - قم بتسجيل جميع المعاملات والأحداث المتعلقة بالمدفوعات
   - قم بإعداد تنبيهات للأنشطة غير العادية
   - راجع السجلات بانتظام

## استكشاف الأخطاء وإصلاحها

عند مواجهة مشاكل في المدفوعات، استخدم هذه الخطوات لاستكشاف الأخطاء وإصلاحها:

1. **التحقق من سجلات Stripe**:
   - في لوحة تحكم Stripe، انتقل إلى "Developers" > "Logs"
   - ابحث عن الأخطاء المتعلقة بالمعاملة المعنية

2. **التحقق من سجلات التطبيق**:
   - راجع سجلات التطبيق للبحث عن أي أخطاء
   - تحقق من استجابات Stripe API

3. **مشاكل شائعة وحلولها**:

   | المشكلة | الحل المحتمل |
   |---------|--------------|
   | رفض البطاقة | تحقق من رمز الخطأ في سجلات Stripe، اطلب من العميل استخدام بطاقة أخرى |
   | فشل Webhook | تحقق من صحة عنوان URL وسر Webhook، تأكد من أن الخادم يمكن الوصول إليه |
   | مشاكل في العمولات | تحقق من حالة الحساب المتصل، تأكد من اكتمال عملية التحقق |
   | أخطاء في الضرائب | تحقق من تكوين الضرائب، تأكد من صحة معلومات العميل |

4. **الاتصال بدعم Stripe**:
   - إذا استمرت المشكلة، اتصل بدعم Stripe
   - قدم معرفات المعاملات ورموز الخطأ ذات الصلة

---

باتباع هذا الدليل، يمكنك الانتقال بنجاح من بيئة Stripe التجريبية إلى البيئة الحقيقية وبدء قبول المدفوعات الفعلية في تطبيق FitMind. تذكر دائماً مراجعة الوثائق الرسمية لـ Stripe للحصول على أحدث المعلومات والتوجيهات.
